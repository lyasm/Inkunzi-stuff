<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Diplomacy Web</title>
	<style>
		#nationDropdown {
			width: 300px;
		}
	</style>
</head>

<body onload="displayNationDetails()">

	<label for="nationDropdown">Select a Nation:</label>
	<input type="text" id="nationDropdown" oninput="filterNations()" list="nationList" onchange="displayNationDetails()">
	<button onclick="displayNationDetails">Update</button>


	<datalist id="nationList"></datalist>
	<label for="depthInput">Depth:</label>
	<input type="number" id="depthInput" value="1" min="1" onchange="updateGraph()">


	<!-- <div id="nationDetails"></div> -->
	<div id="graph"></div>

	<svg width="1960" height="1960"></svg>
	<!-- Load d3.js -->
	<script src="https://d3js.org/d3.v4.min.js"></script>

	<!-- Create a div where the graph will take place -->
	<div id="my_dataviz"></div>


	<script>
		let data;
		let armyData;
		// Fetch The JSON data
		fetch('diplo.json')
			.then(response => response.json())
			.then(jsonData => {
				data = jsonData;

				// Get the datalist and populate it with nation names
				const nationList = document.getElementById('nationList');
				Object.keys(data).forEach(nationName => {
					const option = document.createElement('option');
					option.value = nationName;
					nationList.appendChild(option);
				});
			})
			.catch(error => console.error('Error loading JSON:', error));

		// Fetch the army JSON data
		fetch('army.json')
			.then(response => response.json())
			.then(armyJsonData => {
				armyData = armyJsonData;
			})
			.catch(error => console.error('Error loading army JSON:', error));

		// Function to filter nations based on user input
		function filterNations() {
			const input = document.getElementById('nationDropdown').value.toLowerCase();
			const filteredNations = Object.keys(data).filter(nationName => nationName.toLowerCase().includes(input));

			// Update the datalist with filtered nations
			const nationList = document.getElementById('nationList');
			nationList.innerHTML = '';
			filteredNations.forEach(nationName => {
				const option = document.createElement('option');
				option.value = nationName;
				nationList.appendChild(option);
			});
			updateGraph();
		}

		// 	// Function to display nation details
		// 	function displayNationDetails() {
		// 		const selectedNationName = document.getElementById('nationDropdown').value;
		// 		console.log(selectedNationName);
		// 		const nationDetails = document.getElementById('NationDetails');

		// 		// Find the selected nation in the JSON data
		// 		const selectedNationData = data[selectedNationName];
		// 		console.log(selectedNationData);
		// 		const selectedArmyData = armyData[selectedNationName];
		// 		console.log(selectedArmyData);
		// 		const powArmy = parseInt(selectedArmyData.Pow_Army.replace(/[^0-9]/g, ''), 10);
		// 		console.log(powArmy);
		// 		// Display the details in the HTML
		// 		nationDetails.innerHTML = '<code>' + JSON.stringify(selectedNationData, null, 2) + powArmy + '</code>';
		// }
		function displayNationDetails(selectedNationName) {
			const nationDetails = document.getElementById('nationDetails');
			const armyDetails = document.getElementById('armyDetails');

			// Find the selected nation in the JSON data
			const selectedNationData = data[selectedNationName];

			// Display the details in the HTML
			nationDetails.innerHTML = '<pre>' + JSON.stringify(selectedNationData, null, 2) + '</pre>';
		}

		// Function to update the graph
		function updateGraph() {
			const selectedNationName = document.getElementById('nationDropdown').value;
			const depth = parseInt(document.getElementById('depthInput').value, 10);

			// Get the military alliances and defensive pacts up to the specified depth
			const graphData = getGraphData(selectedNationName, depth);

			// Display the graph data in the HTML
			displayGraph(graphData);
		}

	  // Recursive function to get graph data
	  function getGraphData(nationName, depth, visited = new Set(), nodesMap = new Map()) {
	      if (depth <= 0 || visited.has(nationName)) {
    return null;
  }

	      visited.add(nationName);

  if (!nodesMap.has(nationName)) {
    const node = { id: nationName, name: nationName };
    nodesMap.set(nationName, node);
  }

  const alliances = data[nationName]["Military Alliances"];
  const defensivePacts = data[nationName]["Defensive Pacts"];

  const currentNode = nodesMap.get(nationName);
  const links = [];

  // Process alliances
  if (alliances) {
    alliances.split(', ').forEach(ally => {
      const allyData = getGraphData(ally, depth - 1, visited, nodesMap);
      if (allyData) {
          links.push(...allyData.links, { source: currentNode.id, target: allyData.nodes[0].id });
	  console.log(allyData);
      }
    });
  }

  // Process defensive pacts
  if (defensivePacts) {
    defensivePacts.split(', ').forEach(pact => {
      const pactData = getGraphData(pact, depth - 1, visited, nodesMap);
      if (pactData) {
        links.push(...pactData.links, { source: currentNode.id, target: pactData.nodes[0].id });
      }
    });
  }

  return { nodes: Array.from(nodesMap.values()), links };
    }


		// Function to display the graph data
		function displayGraph(graphData) {
			const graphContainer = document.getElementById('graph');
			graphContainer.innerHTML = '';

			if (!graphData) {
				return;
			}

			const nodes = graphData.nodes;
			const links = graphData.links;

			// Display the graph using your preferred graph visualization library (e.g., D3.js, vis.js, etc.)
			// Here, we'll use a simple textual representation
			const graphText = `
        <p>Nodes:</p>
        <ul>
          ${nodes.map(node => `<li>${node.name}</li>`).join('')}
        </ul>
        <p>Links:</p>
        <ul>
          ${links.map(link => `<li>${link.source} -> ${link.target}</li>`).join('')}
        </ul>
      `;

			graphContainer.innerHTML = graphText;
		}
	</script>


</body>

</html>
